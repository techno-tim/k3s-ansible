---
- name: Check if system is PXE-booted
  command: cat /proc/cmdline
  register: boot_cmdline
  changed_when: false

- name: Set fact for PXE-booted system
  set_fact:
    is_pxe_booted: "{{ 'root=/dev/nfs' in boot_cmdline.stdout }}"
  when: boot_cmdline is defined

- name: Deploy K3s http_proxy conf
  include_tasks: http_proxy.yml
  when: proxy_env is defined

- name: Copy K3s service file
  template:
    src: "k3s.service.j2"
    dest: "{{ systemd_dir }}/k3s-node.service"
    owner: root
    group: root
    mode: 0755

- name: Enable and check K3s service
  systemd:
    name: k3s-node
    daemon_reload: true
    state: restarted
    enabled: true
